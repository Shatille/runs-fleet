name: Build Runner Image

on:
  push:
    tags:
      - 'v*.*.*'
    paths:
      - 'docker/runner/**'
      - 'cmd/agent/**'
      - 'pkg/agent/**'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag (default: latest)'
        required: false
        default: 'latest'

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: runs-fleet-runner
  RUNNER_VERSION: '2.321.0'

jobs:
  build-runner:
    name: Build Multi-arch Runner Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Determine version tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
          elif [ "${{ github.event.inputs.tag }}" != "" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Build and push to staging tag
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/runner/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.version }}-unverified
          build-args: |
            RUNNER_VERSION=${{ env.RUNNER_VERSION }}
            VERSION=${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan image for vulnerabilities
        id: scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.version }}-unverified'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Delete staging image on scan failure
        if: always() && steps.scan.outcome == 'failure'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Vulnerability scan failed. Deleting unverified image..."
          aws ecr batch-delete-image \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --image-ids imageTag="${VERSION}-unverified"

      - name: Promote to final tags
        if: success()
        run: |
          set -e
          REPO="${{ env.ECR_REPOSITORY }}"
          VERSION="${{ steps.version.outputs.version }}"

          echo "Promoting ${VERSION}-unverified to ${VERSION} and latest..."

          # Get the manifest of the unverified image
          MANIFEST=$(aws ecr batch-get-image \
            --repository-name "$REPO" \
            --image-ids imageTag="${VERSION}-unverified" \
            --query 'images[0].imageManifest' \
            --output text)

          # Validate manifest was retrieved
          if [[ -z "$MANIFEST" || "$MANIFEST" == "None" ]]; then
            echo "ERROR: Failed to retrieve manifest for ${VERSION}-unverified"
            exit 1
          fi

          # Put the manifest with the final version tag
          echo "Tagging as ${VERSION}..."
          aws ecr put-image \
            --repository-name "$REPO" \
            --image-tag "$VERSION" \
            --image-manifest "$MANIFEST" \
            || { echo "ERROR: Failed to tag as ${VERSION}"; exit 1; }

          # Put the manifest with the latest tag
          echo "Tagging as latest..."
          aws ecr put-image \
            --repository-name "$REPO" \
            --image-tag "latest" \
            --image-manifest "$MANIFEST" \
            || { echo "ERROR: Failed to tag as latest"; exit 1; }

          # Clean up the unverified tag (non-fatal - images are already promoted)
          aws ecr batch-delete-image \
            --repository-name "$REPO" \
            --image-ids imageTag="${VERSION}-unverified" \
            || echo "Warning: Failed to clean up ${VERSION}-unverified tag"

          echo "Image promoted successfully"

      - name: Image digest
        if: success()
        run: echo "Image pushed with digest ${{ steps.build.outputs.digest }}"
