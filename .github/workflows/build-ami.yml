name: Build Runner AMI

on:
  push:
    branches:
      - main
    paths:
      - "cmd/agent/**"
      - "pkg/agent/**"
      - "packer/**"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ap-northeast-1

jobs:
  build-runner:
    name: Build Runner Image
    uses: ./.github/workflows/build-runner.yml
    secrets:
      AWS_IAM_ROLE_ARN: ${{ secrets.AWS_IAM_ROLE_ARN }}

  build-ami:
    name: Build AMI ${{ matrix.arch }}
    needs: build-runner
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            packer_file: runs-fleet-runner-arm64.pkr.hcl
            launch_template: runs-fleet-runner-arm64
          - arch: amd64
            packer_file: runs-fleet-runner-amd64.pkr.hcl
            launch_template: runs-fleet-runner-amd64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Packer
        uses: hashicorp/setup-packer@main

      - name: Packer Init
        working-directory: packer
        run: packer init ${{ matrix.packer_file }}

      - name: Packer Build
        id: packer
        working-directory: packer
        run: |
          packer build \
            -var "security_group_id=${{ secrets.PACKER_SECURITY_GROUP_ID }}" \
            -var "subnet_id=${{ secrets.PACKER_SUBNET_ID }}" \
            -machine-readable \
            ${{ matrix.packer_file }} | tee packer-output.txt

          AMI_ID=$(grep 'artifact,0,id' packer-output.txt | cut -d: -f2)
          echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT
          echo "Built AMI: $AMI_ID"

      - name: Update Launch Template
        env:
          AMI_ID: ${{ steps.packer.outputs.ami_id }}
          LAUNCH_TEMPLATE: ${{ matrix.launch_template }}
        run: |
          NEW_VERSION=$(aws ec2 create-launch-template-version \
            --launch-template-name "$LAUNCH_TEMPLATE" \
            --source-version '$Latest' \
            --launch-template-data "{\"ImageId\":\"$AMI_ID\"}" \
            --query 'LaunchTemplateVersion.VersionNumber' \
            --output text)

          aws ec2 modify-launch-template \
            --launch-template-name "$LAUNCH_TEMPLATE" \
            --default-version "$NEW_VERSION"

          echo "Updated $LAUNCH_TEMPLATE to version $NEW_VERSION with AMI $AMI_ID"

  cleanup-old-amis:
    name: Cleanup Old AMIs
    needs: build-ami
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deregister old AMIs (keep latest 2)
        run: |
          for arch in arm64 amd64; do
            OLD_AMIS=$(aws ec2 describe-images \
              --owners self \
              --filters "Name=name,Values=runs-fleet-runner-${arch}-*" \
              --query 'sort_by(Images, &CreationDate)[:-2].[ImageId]' \
              --output text)

            for ami in $OLD_AMIS; do
              if [ "$ami" != "None" ] && [ -n "$ami" ]; then
                echo "Deregistering $ami"
                aws ec2 deregister-image --image-id "$ami" || true
              fi
            done
          done
